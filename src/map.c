#include "map.h"

_map map_1 = {
  .tiles = {
  0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
  0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x01, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x04, 0x05, 0x01,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x07, 0x01,
  0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x03, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x02,
  },

  .num_warp_points = 4,
  .warp_points = warp_points_1,
};

_map map_2 = {
  .tiles = {
  0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x00, 0x00, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x02,
  },
  .num_warp_points = 4,
  .warp_points = warp_points_2,
};

_map map_3 = {
  .tiles = {
  0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01,
  0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x01, 0x02,
  },
  .num_warp_points = 4,
  .warp_points = warp_points_3,
};

_warp_point warp_points_1[] = {
  { .tile_x = 0x07, .tile_y = 0x00, .target_map = &map_2, .target_x = 0x07, .target_y = 0x0b },
  { .tile_x = 0x08, .tile_y = 0x00, .target_map = &map_2, .target_x = 0x08, .target_y = 0x0b },
  { .tile_x = 0x0f, .tile_y = 0x02, .target_map = &map_3, .target_x = 0x00, .target_y = 0x08 },
  { .tile_x = 0x0f, .tile_y = 0x03, .target_map = &map_3, .target_x = 0x00, .target_y = 0x09 },
};

_warp_point warp_points_2[] = {
  { .tile_x = 0x07, .tile_y = 0x0b, .target_map = &map_1, .target_x = 0x07, .target_y = 0x00 },
  { .tile_x = 0x08, .tile_y = 0x0b, .target_map = &map_1, .target_x = 0x08, .target_y = 0x00 },
  { .tile_x = 0x0f, .tile_y = 0x08, .target_map = &map_3, .target_x = 0x00, .target_y = 0x02 },
  { .tile_x = 0x0f, .tile_y = 0x09, .target_map = &map_3, .target_x = 0x00, .target_y = 0x03 },
};

_warp_point warp_points_3[] = {
  { .tile_x = 0x00, .tile_y = 0x08, .target_map = &map_1, .target_x = 0x0f, .target_y = 0x02 },
  { .tile_x = 0x00, .tile_y = 0x09, .target_map = &map_1, .target_x = 0x0f, .target_y = 0x03 },
  { .tile_x = 0x00, .tile_y = 0x02, .target_map = &map_2, .target_x = 0x0f, .target_y = 0x08 },
  { .tile_x = 0x00, .tile_y = 0x03, .target_map = &map_2, .target_x = 0x0f, .target_y = 0x09 },
};

unsigned int _meta_tiles[][4] = {
  { 0x13, 0x13, 0x13, 0x13 },
  { 0x09, 0x0a, 0x1c, 0x1d },
  { 0x7a, 0x7b, 0x80, 0x81 },
  { 0x5d, 0x5d|TILE_FLIPPED_X, 0x68, 0x68|TILE_FLIPPED_X },
  { 0x7c, 0x7d, 0x82, 0x83 },
  { 0x7e, 0x7f, 0x84, 0x85 },
  { 0x86, 0x87, 0x8a, 0x8b },
  { 0x88, 0x89, 0x8c, 0x8d }
};

_map *current_map = &map_1;

void init_map() {
}

void _draw_map_row(char row_number) {
  SMS_setNextTileatXY(0, (row_number << 1));

  for (char x = 0; x < MAP_WIDTH; ++x) {
    const char meta_tile_idx = current_map_tiles[row_number * MAP_WIDTH + x];

    SMS_setTile(_meta_tiles[meta_tile_idx][0]);
    SMS_setTile(_meta_tiles[meta_tile_idx][1]);
  }

  for (char x = 0; x < MAP_WIDTH; ++x) {
    const char meta_tile_idx = current_map_tiles[row_number * MAP_WIDTH + x];

    SMS_setTile(_meta_tiles[meta_tile_idx][2]);
    SMS_setTile(_meta_tiles[meta_tile_idx][3]);
  }
}

void draw_map() {
  // SMS_VRAMmemcpy(0x3800, map_tiles, 2 * 32 * 24);
  for (unsigned char row = 0; row < MAP_HEIGHT; ++row) {
    _draw_map_row(row);
  }
}

_warp_point *find_warp_point(char tile_x, char tile_y) {
  char count = current_map->num_warp_points;

  for (char n = 0; n < count; ++n) {
    _warp_point *wp = &current_map->warp_points[n];

    char warp_point_x = wp->tile_x;
    char warp_point_y = wp->tile_y;

    if (tile_x == warp_point_x && tile_y == warp_point_y) {
      return wp;
    }
  }

  return 0;
}

char lookup_tile(char tile_x, char tile_y) {
  return current_map->tiles[tile_y * MAP_WIDTH + tile_x];
}

void handle_warp_point(_player *player, _warp_point *warp_point) {
  char tile_x = warp_point->target_x;
  char tile_y = warp_point->target_y;

  player->tile_x = tile_x;
  player->pos_x = tile_x * 16;
  player->tile_y = tile_y;
  player->pos_y = tile_y * 16;
  player->just_warped = 1;

  current_map = warp_point->target_map;

  SMS_waitForVBlank();
  reload_bg_palette_half_brightness(1);
  reload_sprite_palette_half_brightness(1);
  SMS_waitForVBlank();
  SMS_waitForVBlank();
  SMS_waitForVBlank();
  SMS_waitForVBlank();
  SMS_displayOff();

  SMS_waitForVBlank();
  SMS_waitForVBlank();
  SMS_waitForVBlank();
  SMS_waitForVBlank();

  SMS_updateSpritePosition(player->sprite_a, player->pos_x, player->pos_y);
  SMS_updateSpritePosition(player->sprite_b, player->pos_x + 8, player->pos_y);
  SMS_copySpritestoSAT();

  draw_map();

  SMS_displayOn();

  SMS_waitForVBlank();
  SMS_waitForVBlank();
  SMS_waitForVBlank();
  SMS_waitForVBlank();

  reload_bg_palette_half_brightness(0);
  reload_sprite_palette_half_brightness(0);
}
